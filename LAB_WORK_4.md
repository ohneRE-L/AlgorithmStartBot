# ЛАБОРАТОРНАЯ РАБОТА №4

**По дисциплине:** Проектирование информационных систем

**Тема занятия:** Разработка - sprint 2

**Цель занятия:** Научиться разрабатывать ИС с использованием Scrum методологии

---

## 1. ВВЕДЕНИЕ

В рамках sprint 2 спроектирована и реализована база данных информационной системы для Telegram-бота анализа аэрофотоснимков. Система автоматизирует процесс анализа данных с БПЛА: загрузка файлов, валидация, запуск анализа и получение результатов с метаданными.

## 2. АРХИТЕКТУРА СИСТЕМЫ

Система построена на трёхуровневой архитектуре:

### 2.1. Уровень представления (Presentation Tier)

• Клиентское приложение: Telegram Bot API

• Пользователи взаимодействуют через Telegram-интерфейс

• Используется библиотека python-telegram-bot

### 2.2. Уровень бизнес-логики (Application Tier)

• Сервер приложений: Python-приложение

• Компоненты:
  • `handlers/` — обработчики команд и сообщений
  • `database/repository.py` — репозиторий для работы с БД (бизнес-операции)
  • `server_client.py` — клиент для взаимодействия с сервером алгоритмов
  • `utils/file_validator.py` — валидация данных

### 2.3. Уровень данных (Data Tier)

• Сервер БД: PostgreSQL 15+

• Хранение пользователей, задач анализа и результатов

• Использование SQLAlchemy ORM для работы с данными

## 3. ПРОЕКТИРОВАНИЕ БАЗЫ ДАННЫХ

### 3.1. Концептуальная модель

Система включает три основные сущности:

• **Пользователи (Users)** — сотрудники компании, использующие бота

• **Задачи (Tasks)** — задачи на анализ аэрофотоснимков

• **Результаты (Results)** — результаты анализа с метаданными

### 3.2. Физическая модель данных

#### 3.2.1. Таблица users (Пользователи)

**Назначение:** Хранение информации о пользователях Telegram-бота

| Поле | Тип данных | Ограничения | Описание |
|------|------------|-------------|----------|
| telegram_id | BIGINT | PRIMARY KEY | Уникальный ID пользователя в Telegram (он же первичный ключ) |
| username | VARCHAR(255) | NULL | Никнейм (для удобства админа) |
| role | VARCHAR(50) | NOT NULL, CHECK | Роль: 'OPERATOR' или 'MODERATOR' |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | Дата регистрации |

#### 3.2.2. Таблица tasks (Задачи на анализ)

**Назначение:** Связующее звено. Создается в момент, когда юзер отправляет картинку. Хранит путь к исходному файлу и текущий статус.

| Поле | Тип данных | Ограничения | Описание |
|------|------------|-------------|----------|
| id | UUID | PRIMARY KEY, DEFAULT gen_random_uuid() | Уникальный номер задачи |
| user_id | BIGINT | FOREIGN KEY | Ссылка на таблицу users (кто отправил) |
| input_file_path | TEXT | NOT NULL | Путь к файлу (ортофотоплану) на диске сервера |
| status | VARCHAR(50) | DEFAULT 'PENDING' | Статус: 'PENDING' (в очереди), 'PROCESSING' (обрабатывается), 'DONE' (готово) |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | Время создания задачи |

#### 3.2.3. Таблица results (Результаты анализа)

**Назначение:** Создается, когда алгоритм закончил работу. Здесь лежит путь к готовой маске и метаданные (площади полей, найденные классы и т.д.).

| Поле | Тип данных | Ограничения | Описание |
|------|------------|-------------|----------|
| id | UUID | PRIMARY KEY, DEFAULT gen_random_uuid() | Уникальный номер результата |
| task_id | UUID | FOREIGN KEY, NOT NULL | Ссылка на таблицу tasks (к какой задаче этот результат) |
| result_file_path | TEXT | NOT NULL | Путь к сгенерированной картинке/маске на диске |
| metadata | JSONB | NULL | Метаданные анализа. Здесь храним всё: { "forest_area": 12.5, "field_area": 40.2, "confidence": 0.98 } |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | Время завершения анализа |

#### 3.2.4. Индексы

Для оптимизации запросов созданы индексы:

```sql
CREATE INDEX idx_tasks_user ON tasks(user_id);
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_results_task ON results(task_id);
```

## 4. РЕАЛИЗАЦИЯ БАЗЫ ДАННЫХ

### 4.1. Инструментальные средства

• СУБД: PostgreSQL 15+

• ORM: SQLAlchemy 2.0+

• Драйвер БД: asyncpg (асинхронный доступ)

• Язык программирования: Python 3.8+

### 4.2. Модели данных (SQLAlchemy)

Реализованы модели в `database/models.py`:

• `User` — модель пользователя

• `Task` — модель задачи

• `Result` — модель результата анализа (включает поле `metadata` типа `JSONB`)

### 4.3. Репозиторий (Repository Pattern)

В `database/repository.py` реализованы методы:

• `UserRepository.get_or_create_user()` — получение/создание пользователя

• `UserRepository.update_user_role()` — обновление роли пользователя

• `TaskRepository.create_task()` — создание задачи

• `TaskRepository.update_task_status()` — обновление статуса задачи

• `TaskRepository.get_user_tasks()` — получение задач пользователя

• `ResultRepository.create_result()` — создание результата анализа (принимает параметр `metadata` для сохранения метаданных в формате JSONB)

• `ResultRepository.get_result_by_task()` — получение результата по task_id

## 5. SQL-СКРИПТ (DDL) ДЛЯ СОЗДАНИЯ БАЗЫ ДАННЫХ

```sql
-- 1. Таблица пользователей
CREATE TABLE users (
    telegram_id BIGINT PRIMARY KEY,
    username VARCHAR(255),
    role VARCHAR(50) NOT NULL CHECK (role IN ('OPERATOR', 'MODERATOR')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 2. Таблица задач (очередь на обработку)
CREATE TABLE tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id BIGINT REFERENCES users(telegram_id),
    input_file_path TEXT NOT NULL,
    status VARCHAR(50) DEFAULT 'PENDING', 
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 3. Таблица результатов (здесь храним метаданные)
CREATE TABLE results (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    task_id UUID REFERENCES tasks(id) ON DELETE CASCADE,
    result_file_path TEXT NOT NULL,
    metadata JSONB, -- Самое важное поле: сюда алгоритм пишет площади, классы и точность
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Индексы для ускорения поиска
CREATE INDEX idx_tasks_user ON tasks(user_id);
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_results_task ON results(task_id);
```

## 6. ОЦЕНКА МОДЕЛИ ДАННЫХ

### 6.1. Структурная достоверность

Модель соответствует бизнес-процессу: регистрация пользователей, создание задач, отслеживание статусов, сохранение результатов с метаданными. Использование JSONB для метаданных позволяет алгоритму сохранять любую аналитику (например: "Лес: 30%, Пашня: 70%") без переделки структуры БД.

### 6.2. Простота

Всего 3 таблицы, ничего лишнего. Четко видно: Юзер -> Задача (Фото) -> Результат (Метаданные + Маска).

### 6.3. Выразительность

• Разделение ролей через CHECK-ограничение (OPERATOR, MODERATOR)

• Детальное отслеживание статусов задач (PENDING, PROCESSING, DONE)

• Связь пользователь-задачи-результаты через внешние ключи

• Гибкое хранение метаданных через JSONB

### 6.4. Отсутствие избыточности

Нормализация: пользователи хранятся отдельно, задачи ссылаются на пользователей через внешний ключ. Результаты хранятся отдельно и ссылаются на задачи. Метаданные хранятся в JSONB, что исключает необходимость создания множества полей для различных типов данных.

### 6.5. Расширяемость

• Легко добавить новые роли через CHECK-ограничение

• Возможность добавления полей в таблицы

• Индексы для оптимизации запросов

• Автоматическая миграция при добавлении новых полей

• JSONB позволяет хранить любые метаданные без изменения схемы БД

### 6.6. Целостность

• Первичные ключи

• Внешние ключи с CASCADE DELETE для results

• NOT NULL для обязательных полей

• CHECK-ограничения для ролей

• Значения по умолчанию

• Транзакционность операций

## 7. БИЗНЕС-ЛОГИКА

Бизнес-логика вынесена в репозиторий (`database/repository.py`):

• Валидация данных при создании записей

• Автоматическое присвоение ролей новым пользователям (по умолчанию OPERATOR)

• Автоматическое отслеживание времени создания

• Обработка ошибок и транзакций

• Автоматическая миграция структуры БД при запуске приложения

• Сохранение метаданных анализа в формате JSONB

## 8. ЗАКЛЮЧЕНИЕ

В рамках sprint 2 спроектирована и реализована база данных для информационной системы анализа аэрофотоснимков. Система использует трёхуровневую архитектуру, что обеспечивает разделение ответственности и масштабируемость. База данных соответствует требованиям:

• Структурная достоверность

• Простота и понятность

• Выразительность

• Отсутствие избыточности

• Расширяемость

• Целостность данных

**Почему именно так?**

• **Простота:** Всего 3 таблицы, ничего лишнего.

• **Метаданные:** Поле `metadata JSONB` в таблице `results` позволяет алгоритму сохранять любую аналитику (например: "Лес: 30%, Пашня: 70%") без переделки структуры БД.

• **Связь:** Четко видно: Юзер -> Задача (Фото) -> Результат (Метаданные + Маска).

---

